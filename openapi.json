{
  "openapi": "3.0.0",
  "info": {
    "title": "ISW Company Similarity API",
    "version": "2.0.0",
    "description": "Multi-jurisdiction entity similarity search using vector embeddings and revenue data"
  },
  "servers": [
    {
      "url": "http://127.0.0.1:5000/v1",
      "description": "Development server"
    }
  ],
  "paths": {
    "/entities": {
      "get": {
        "summary": "List Entities",
        "description": "Get paginated list of entities",
        "tags": ["Entities"],
        "parameters": [
          {
            "name": "page",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 1,
              "minimum": 1
            }
          },
          {
            "name": "page_size",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 10,
              "minimum": 1,
              "maximum": 100
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Success",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntityListResponse"
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Create Entity",
        "description": "Add a new entity to the database",
        "tags": ["Entities"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateEntityRequest"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CreateEntityResponse"
                }
              }
            }
          },
          "200": {
            "description": "Entity already exists",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CreateEntityResponse"
                }
              }
            }
          }
        }
      }
    },
    "/entities/{identifier}": {
      "get": {
        "summary": "Get Entity",
        "description": "Get detailed information for a specific entity",
        "tags": ["Entities"],
        "parameters": [
          {
            "name": "identifier",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "CIK (US) or LEI (EU/UK) identifier"
          }
        ],
        "responses": {
          "200": {
            "description": "Success",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EntityResponse"
                }
              }
            }
          },
          "404": {
            "description": "Entity not found"
          }
        }
      },
      "patch": {
        "summary": "Update Entity",
        "description": "Update an existing entity's data",
        "tags": ["Entities"],
        "parameters": [
          {
            "name": "identifier",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdateEntityRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Success",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UpdateEntityResponse"
                }
              }
            }
          },
          "404": {
            "description": "Entity not found"
          }
        }
      },
      "delete": {
        "summary": "Delete Entity",
        "description": "Remove an entity from the database",
        "tags": ["Entities"],
        "parameters": [
          {
            "name": "identifier",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Success",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/DeleteEntityResponse"
                }
              }
            }
          },
          "404": {
            "description": "Entity not found"
          }
        }
      }
    },
    "/entities/{identifier}/search": {
      "get": {
        "summary": "Search Similar Entities",
        "description": "Find entities similar to target using vector embeddings",
        "tags": ["Entities", "Similarity Search"],
        "parameters": [
          {
            "name": "identifier",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "CIK or LEI of the source entity"
          },
          {
            "name": "similarity_threshold",
            "in": "query",
            "schema": {
              "type": "number",
              "default": 0.7,
              "minimum": 0,
              "maximum": 1
            },
            "description": "Minimum cosine similarity score"
          },
          {
            "name": "max_results",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 10,
              "minimum": 1,
              "maximum": 100
            },
            "description": "Maximum number of results to return"
          },
          {
            "name": "filter_community",
            "in": "query",
            "schema": {
              "type": "boolean",
              "default": true
            },
            "description": "Only return entities in the same Leiden community"
          }
        ],
        "responses": {
          "200": {
            "description": "Success",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SimilarEntitiesResponse"
                }
              }
            }
          },
          "404": {
            "description": "Source entity not found"
          },
          "400": {
            "description": "Source entity has no embedding"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "Entity": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "Internal database ID"
          },
          "identifier": {
            "type": "string",
            "description": "CIK (10-digit) or LEI (20-char)"
          },
          "identifier_type": {
            "type": "string",
            "enum": ["CIK", "LEI"],
            "description": "Type of identifier"
          },
          "jurisdiction": {
            "type": "string",
            "enum": ["US", "EU", "UK"],
            "description": "Regulatory jurisdiction"
          },
          "name": {
            "type": "string",
            "description": "Legal entity name"
          },
          "description": {
            "type": "string",
            "description": "Business description"
          },
          "revenue_raw": {
            "type": "number",
            "description": "Revenue in source currency"
          },
          "revenue_currency": {
            "type": "string",
            "description": "ISO currency code (USD, EUR, GBP, etc.)"
          },
          "revenue_usd": {
            "type": "number",
            "description": "Revenue converted to USD"
          },
          "revenue_period_end": {
            "type": "string",
            "description": "Fiscal period end date (YYYY-MM-DD)"
          },
          "revenue_source_tags": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "XBRL tags used for revenue extraction"
          },
          "norm_tot_rev": {
            "type": "integer",
            "description": "Revenue percentile bucket (1-100)"
          },
          "cluster": {
            "type": "integer",
            "description": "HDBSCAN cluster assignment"
          },
          "leiden_community": {
            "type": "integer",
            "description": "Leiden community assignment"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "CreateEntityRequest": {
        "type": "object",
        "required": ["identifier", "identifier_type", "jurisdiction", "name"],
        "properties": {
          "identifier": {
            "type": "string",
            "description": "CIK or LEI"
          },
          "identifier_type": {
            "type": "string",
            "enum": ["CIK", "LEI"]
          },
          "jurisdiction": {
            "type": "string",
            "enum": ["US", "EU", "UK"]
          },
          "name": {
            "type": "string"
          }
        }
      },
      "CreateEntityResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "object",
            "properties": {
              "identifier": {
                "type": "string"
              },
              "created": {
                "type": "boolean"
              }
            }
          },
          "status": {
            "type": "integer"
          }
        }
      },
      "UpdateEntityRequest": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "revenue_raw": {
            "type": "number"
          },
          "revenue_currency": {
            "type": "string"
          },
          "revenue_usd": {
            "type": "number"
          },
          "revenue_period_end": {
            "type": "string"
          }
        }
      },
      "UpdateEntityResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "object",
            "properties": {
              "identifier": {
                "type": "string"
              },
              "updated": {
                "type": "boolean"
              }
            }
          },
          "status": {
            "type": "integer"
          }
        }
      },
      "DeleteEntityResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "object",
            "properties": {
              "identifier": {
                "type": "string"
              },
              "deleted": {
                "type": "boolean"
              }
            }
          },
          "status": {
            "type": "integer"
          }
        }
      },
      "EntityResponse": {
        "type": "object",
        "properties": {
          "data": {
            "$ref": "#/components/schemas/Entity"
          },
          "status": {
            "type": "integer"
          }
        }
      },
      "EntityListResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "object",
            "properties": {
              "entities": {
                "type": "array",
                "items": {
                  "$ref": "#/components/schemas/Entity"
                }
              },
              "total_pages": {
                "type": "integer"
              },
              "total_count": {
                "type": "integer"
              },
              "page": {
                "type": "integer"
              },
              "page_size": {
                "type": "integer"
              }
            }
          },
          "status": {
            "type": "integer"
          }
        }
      },
      "SimilarEntitiesResponse": {
        "type": "object",
        "properties": {
          "data": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "entity": {
                  "$ref": "#/components/schemas/Entity"
                },
                "similarity": {
                  "type": "number",
                  "description": "Cosine similarity score (0-1)"
                }
              }
            }
          },
          "status": {
            "type": "integer"
          }
        }
      }
    }
  }
}
